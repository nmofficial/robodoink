<!DOCTYPE html>
<html>

<head>
  <title> Robodoink </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" type="text/css" href="style1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
</head>

<body onload="startGame()">
  <center>
  <div id="insertHere"></div>
  <div id = "restartButton"></div>
  <h1>
    Robodoink
  </h1>
  <div>
  </div>

  <p>
    When in doubt,
  </p>
  <p>
    doink it out!
  </p>
  </center>
</body>

<script>

var myDoinker, myScore;
var rightDown = false;
var leftDown = false;
var upDown = false;

var dead = false;

var canPressUp = true;
var canPressUpInter = true;

var veggies = [];
var die = false;

function startGame() {
  myGameArea.start();
  myDoinker = new component(10, "#ff9900", 100, 260, 0, 0);
  myScore = new component("30px", "blue", 20, 40, 0, 0, "Arial", "text");
  for (var i = 0; i < 3; i++) {
    // var startX = 15 + Math.floor((Math.random()) * (myGameArea.canvas.width - 29));
    var startSide = Math.round(Math.random());
    if (startSide == 0) {
      veggies.push(new component(15, "green", -15, 256, 1, 0, -1, "veggie"));
    } else {
      veggies.push(new component(15, "green", myGameArea.canvas.width + 15, 256, -1, 0, -1, "veggie"));
    }
  }
}

window.onkeydown = function(e) {
  // window.addEventListener('keydown', function (e) {
  if (e.keyCode == 65) leftDown = true;
  if (e.keyCode == 68) rightDown = true;
  if ((e.keyCode == 87) && (myDoinker.y >= 10)) upDown = true;
}

window.onkeyup = function(e) {
  // window.addEventListener('keyup', function (e) {
  if (e.keyCode == 65) leftDown = false;
  if (e.keyCode == 68) rightDown = false;
  if (e.keyCode == 87) {
    upDown = false;
    canPressUp = true;
  }
}

function gravity() {

}

var myGameArea = {
  canvas : document.createElement("canvas"),
  start : function() {
    this.canvas.width = 480;
    this.canvas.height = 270;
    this.canvas.id="gameAreaCanvas";
    this.context = this.canvas.getContext("2d");
    document.getElementById("insertHere").appendChild(this.canvas);
    this.frameNumber = 0;
    this.interval = setInterval(updateGameArea, 5);
  },
  clear : function(){
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
  },
  stop : function(){
    // const context = canvas.getContext('2d');
    // myGameArea.context.clearRect(0, 0, canvas.width, canvas.height);
    myGameArea.clear();
  }
}

function component(radius, color, x, y, dx, dy, extra, type) {
  this.type = type;
  this.width = radius;
  this.speedX = dx;
  this.speedY = dy;
  this.score = 0;
  this.dstreak = 0;
  this.pointValue = 10;
  this.x = x;
  this.y = y;
  this.extra = extra;
  // var randomDirection = Math.random()*2;
  // if (randomDirection < 1) {this.vegetableDirection = 1; }
  // else {this.vegetableDirection = -1; }

  if (this.type == "veggie") this.vegetableDirection = this.speedX;

  this.update = function() {

    ctx = myGameArea.context;

    if (this.type == "text") {
      ctx.font = this.width + " " + this.extra;
      ctx.fillStyle = color;
      ctx.fillText(this.text, this.x, this.y);
    } else {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.width, 0, Math.PI*2);
      ctx.fillStyle = color;
      ctx.fill();
    }
  }
  this.newPosition = function() {
    this.x += this.speedX;
    this.y += this.speedY;
  }
}

//set intial speed for X and Y. Y won't reset so gravity will work.
myDoinker.speedX = 0;
myDoinker.speedY = 0;

function collisions() {
  for (var i = 0; i < veggies.length; i++) {
    if (Math.abs(myDoinker.x - veggies[i].x) < myDoinker.width) {
      if (veggies[i].y - myDoinker.y > veggies[i].width/4 && veggies[i].y - myDoinker.y < myDoinker.width + veggies[i].width) {
        myDoinker.streak++;
        myDoinker.score += veggies[i].pointValue * myDoinker.streak;
        veggies.splice(i, 1);
        myDoinker.speedY = -1.85;
        var startSide = Math.round(Math.random());
        if (startSide == 0) {
          veggies.push(new component(15, "green", -15, 256, 1, 0, -1, "veggie"));
        } else {
          veggies.push(new component(15, "green", myGameArea.canvas.width + 15, 256, -1, 0, -1, "veggie"));
        }
      } else if (veggies[i].y - myDoinker.y <= veggies[i].width/4) {
        die = true;
      }
    }
  }
}

function htmlToElement(html) {
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content;
}

function reload(){
	location.reload();
}


function updateGameArea() {
  if(dead){
    
  }

  else if(die){
    myGameArea.stop();
    console.log("score: " + myDoinker.score);
    (document.getElementById("restartButton")).appendChild(htmlToElement("<h1>You Died :(</h1>"));
    (document.getElementById("restartButton")).appendChild(htmlToElement("<h1 style='background-color:green'>Score: "+myDoinker.score+"</h1>"));
    (document.getElementById("restartButton")).appendChild(htmlToElement("<center><button onclick='reload()'>Restart!</button></center>"));
    dead = true;
  }
  else {
    myGameArea.clear();
    myGameArea.frameNumber++;
    myDoinker.speedX = 0;

    if (myDoinker.x >= myGameArea.canvas.width - 10) {rightDown = false;}
    if (myDoinker.x <= 10) {leftDown = false;}


    if (leftDown) {myDoinker.speedX = -.75; }
    if (rightDown) {myDoinker.speedX = .75; }

    if (upDown) {
      if (canPressUp && canPressUpInter) myDoinker.speedY = -1.85;
      canPressUp = false;
      canPressUpInter = false;
    }


    //gravity
    if (myDoinker.y < 260) {
      myDoinker.speedY += 0.035;
    } else if (myDoinker.y > 260){
      myDoinker.y = 260;
      myDoinker.speedY = 0;
    } else if (myDoinker.y >= 260) {
      canPressUpInter = true;
    }

    //for testing purposes:
    console.log(myGameArea.frameNumber);
    console.log(myDoinker.y);
    console.log(myDoinker.speedY);

    if(myDoinker.y == 260) {myDoinker.streak = 0;}

    myDoinker.newPosition();
    myDoinker.update();

    for (var i = 0; i < veggies.length; i++) {
      //if ((veggies[i].x >= myGameArea.canvas.width - 15) || veggies[i].x <= 10) {veggies[i].vegetableDirection = veggies[i].vegetableDirection * -1;}
      if (veggies[i].vegetableDirection == 1) {veggies[i].speedX = .3;}
      else {veggies[i].speedX = -.3;}
      veggies[i].newPosition();
      veggies[i].update();
    }

    collisions();
    myScore.text = "SCORE: " + myDoinker.score;
    myScore.update();
  }
}

</script>
</html>
